## 技术方案概览
| 项目 | 具体信息 |
|------|----------|
| **核心工具** | CloudFlare CDN及代理服务 |
| **实现原理** | 利用CloudFlare的HTTP/HTTPS代理功能，将您的域名指向任意IPv4地址 |
| **主要用途** | 隐藏服务器真实IP、绕过端口限制、为无公网IP设备提供访问 |
| **完全免费** | CloudFlare基础套餐即可实现，无需付费 |
| **前置要求** | 一个属于自己的域名（可在Namesilo等平台低价购买） |

---
## 一、核心原理与优势
### 1.1 它是如何工作的？
```
传统直连：
用户 → 直接访问服务器IP:端口

CloudFlare代理后：
用户 → 访问您的域名（如 proxy.yourdomain.com）
      ↓
CloudFlare全球网络（充当中间人）
      ↓
您的服务器（任何IPv4地址，甚至家宽动态IP）
```
**关键点**：所有流量经由CloudFlare转发，**用户看不到您的真实IP**。

### 1.2 相比直接暴露IP的优势
| 对比维度 | 直接暴露IP | 使用CloudFlare代理 |
|----------|------------|---------------------|
| **IP隐私** | 完全暴露 | 完全隐藏 |
| **DDoS防护** | 无或自建 | 享受CloudFlare基础防护 |
| **端口限制** | 需开放服务器端口 | 仅需标准80/443（HTTP/HTTPS） |
| **网络环境** | 要求有公网IP | 即使没有公网IP，只要有出网能力即可 |

---
## 二、前期准备
### 2.1 必备条件清单
- [ ] **一个域名**（例如：`yourdomain.com`，年费约¥50-80）
- [ ] **CloudFlare账户**（免费注册）【点击前往注册】
- [ ] **需要代理的服务**（运行在您的服务器/电脑上，如网站、NAS等）

### 2.2 域名准备（如果尚无）
1. **选购域名**：推荐Namesilo、CloudFlare Registrar等性价比高的注册商
2. **完成购买**：选择`.com`、`.net`或`.xyz`等常见后缀
3. **记住关键信息**：注册商提供的**域名服务器（Nameserver）** 地址

---
## 三、逐步配置教程
### 3.1 第一步：将域名接入CloudFlare
```
操作路径：
1. 登录CloudFlare仪表板
2. 点击“添加站点”
3. 输入您的完整域名（如 yourdomain.com）
4. 选择免费计划
5. 按照提示，将您的域名服务器修改为CloudFlare提供的地址
```
> **ⓘ 重要提示**：域名服务器变更需要**最多48小时**全球生效，通常几分钟到几小时。在此期间请耐心等待。

### 3.2 第二步：添加DNS记录（实现反向代理）
**场景示例**：将家中的NAS（IP: `192.168.1.100:5000`）通过域名`nas.yourdomain.com`安全暴露到公网。

| 字段 | 填写值 | 说明 |
|------|--------|------|
| **类型** | `A` | 指向IPv4地址 |
| **名称** | `nas` | 子域名前缀，完整域名为 `nas.yourdomain.com` |
| **IPv4地址** | `192.168.1.100` | **这里填写您服务器的内网IP即可** |
| **代理状态** | ✅ (已代理) | **必须打开（橙色云朵）**，这是实现代理的关键 |
| **TTL** | 自动 | 保持默认 |

**操作截图示意位置**：
![在CloudFlare DNS页面添加A记录并开启代理](https://example.com/cf-dns-proxy.png)

> **⚠️ 安全警告**：代理状态必须是**橙色云朵（已代理）**。如果是灰色云朵，流量将直连您的IP，无法隐藏。

### 3.3 第三步：配置SSL/TLS加密（实现HTTPS访问）
```
操作路径：
仪表板 → SSL/TLS → 概述
将加密模式设置为“完全”
```
| 加密模式 | 描述 | 推荐 |
|----------|------|------|
| **关闭** | 不加密，HTTP访问 | 不推荐 |
| **灵活** | 用户 ↔ CloudFlare 加密 | 快，但到服务器段不加密 |
| **完全** | 全程加密，需服务器有证书 | **最推荐** |
| **完全（严格）** | 全程加密，且验证证书 | 要求最高，适合高级用户 |

> **💡 提示**：选择“完全”模式，CloudFlare会为您的域名自动生成并管理SSL证书，实现`https://`访问，无需您在服务器上配置。

### 3.4 第四步：源服务器配置（让CloudFlare能连接您的服务）
您的服务器（IP: `192.168.1.100`）需要：
1. **确保服务运行**：NAS的Web服务（端口5000）正常启动。
2. **配置Web服务器（以Nginx为例，关键）**：
```nginx
server {
    listen 80; # 只需监听HTTP 80端口
    server_name nas.yourdomain.com; # 与CloudFlare设置的域名一致

    location / {
        proxy_pass http://localhost:5000; # 转发到实际服务端口
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # 关键：允许来自CloudFlare IP段的请求
        set_real_ip_from 173.245.48.0/20;
        set_real_ip_from 103.21.244.0/22;
        # ... (添加所有CloudFlare IP段，可在CF官网查找)
        real_ip_header CF-Connecting-IP;
    }
}
```
3. **防火墙设置**：只需在路由器上**关闭**对公网的5000端口映射。所有请求都将通过CloudFlare的80/443端口进入，再被Nginx转发。

---
## 四、高级配置与优化
### 4.1 使用规则（Rules）进行访问控制
**场景**：只想让特定IP访问您的NAS管理界面。
```
操作路径：
仪表板 → 规则 → 防火墙规则 → 创建规则
规则名称： “限制NAS访问”
字段： “来源IP地址” “不属于” “您的办公室IP/家庭IP”
操作： “阻止”
```
这样，只有您指定的IP才能访问，极大增强安全性。

### 4.2 缓存配置（加速静态内容）
对于博客、图片站等静态资源多的服务，可以开启缓存。
```
操作路径：
仪表板 → 缓存 → 配置
“缓存级别”选择：标准
“浏览器缓存TTL”：设置一个时间（如4小时）
```

### 4.3 处理WebSocket应用（如Bitwarden、实时监控）
如果代理的应用使用WebSocket，需额外设置：
```
操作路径：
仪表板 → 网络
找到“WebSocket”选项，确保其处于启用状态。
同时在Nginx配置中添加：
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
```

---
## 五、常见问题排查（FAQ）
| 问题现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 访问域名显示 `520/521/525` 等错误 | CloudFlare无法连接到您的源服务器 | 1. 检查源服务器是否运行、80端口是否监听<br>2. 检查服务器防火墙是否允许CloudFlare的IP段<br>3. 检查Nginx/Apache配置是否正确 |
| 可以HTTP访问，但HTTPS不行 | SSL/TLS模式设置错误 | 将SSL/TLS模式改为“完全” |
| 访问很慢 | 可能被分配到远的CloudFlare节点；源服务器慢 | 1. 在规则中设置“自定义主机名”试试（高级）<br>2. 优化源服务器响应速度 |
| 真实IP还是被泄露了 | 服务直接返回了服务器IP | 检查应用配置，确保其信任 `X-Forwarded-For` 头，并使用 `CF-Connecting-IP` 获取真实用户IP |

---
## 六、安全检查清单
配置完成后，请务必验证：
- [ ] **DNS记录**：代理状态是否为橙色云朵？
- [ ] **SSL/TLS**：加密模式是否为“完全”？浏览器访问是否为绿色小锁？
- [ ] **IP隐藏**：通过第三方网站（如 `ipcheck.com` ）访问您的域名，显示的是否为CloudFlare的IP？
- [ ] **访问控制**：是否已设置防火墙规则限制来源IP？
- [ ] **源服务器**：防火墙是否已**禁止**直接从公网访问服务端口（如5000）？

---
## 📊 方案总结与下一步
您已成功搭建了一个**免费、安全、高性能**的反向代理。它就像为您的服务穿上了一件“CloudFlare隐身衣”。

| 特性 | 评价 |
|------|------|
| **成本** | ⭐⭐⭐⭐⭐ (完全免费) |
| **安全性** | ⭐⭐⭐⭐ (隐藏IP，基础DDoS防护) |
| **易用性** | ⭐⭐⭐⭐ (配置直观，但有网络基础要求) |
| **可靠性** | ⭐⭐⭐⭐⭐ (依托CloudFlare全球网络) |
| **适用性** | ⭐⭐⭐⭐ (完美应对个人项目、轻量业务) |
